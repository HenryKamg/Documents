# 删除自动伸缩集群

## 删除基本集群

* 前提：

* 操作：

  1. 登录到 Controller 节点，加载所要删除的基本集群的拥有者的环境变量脚本；
  1. 查看集群列表：

    ```
    # heat stack-list
    +--------------------------------------+---------------+-----------------+----------------------+
    | id                                   | stack_name    | stack_status    | creation_time        |
    +--------------------------------------+---------------+-----------------+----------------------+
    | 35d55dd4-45ec-464d-b1de-b3f63e8e0510 | coffee_base   | CREATE_COMPLETE | 2015-10-09T11:06:29Z |
    +--------------------------------------+---------------+-----------------+----------------------+
    ```
  1. 删除集群：

    ```
    # heat stack-delete <STACK_NAME>
    +--------------------------------------+---------------+--------------------+----------------------+
    | id                                   | stack_name    | stack_status       | creation_time        |
    +--------------------------------------+---------------+--------------------+----------------------+
    | 35d55dd4-45ec-464d-b1de-b3f63e8e0510 | coffee_base   | DELETE_IN_PROGRESS | 2015-10-09T11:06:29Z |
    +--------------------------------------+---------------+--------------------+----------------------+
    ```
  1. 查看云主机列表，验证集群中的云主机是否被删除。

* 预期结果：

  * 删除集群，集群处于 "DELETE_IN_PROGRESS" 状态，删除完成后，集群信息不再显示在列表中：

    ```
    # heat stack-delete coffee_base
    +--------------------------------------+---------------+--------------------+----------------------+
    | id                                   | stack_name    | stack_status       | creation_time        |
    +--------------------------------------+---------------+--------------------+----------------------+
    | 35d55dd4-45ec-464d-b1de-b3f63e8e0510 | coffee_base   | DELETE_IN_PROGRESS | 2015-10-09T11:06:29Z |
    +--------------------------------------+---------------+--------------------+----------------------+
    ```
  * 查看云主机列表，云主机以被删除，列表为空（该租户下没有其他云主机）：

    ```
    # nova list
    +----+------+--------+------------+-------------+----------+
    | ID | Name | Status | Task State | Power State | Networks |
    +----+------+--------+------------+-------------+----------+
    +----+------+--------+------------+-------------+----------+
    ```

## 删除自动伸缩集群


* 前提：

* 操作：

  1. 登录到 Controller 节点，加载所要删除的基本集群的拥有者的环境变量脚本；
  1. 查看集群列表：

    ```
    # heat stack-list
    +--------------------------------------+------------------+-----------------+----------------------+
    | id                                   | stack_name       | stack_status    | creation_time        |
    +--------------------------------------+------------------+-----------------+----------------------+
    | 0d58af3f-d0d6-40ef-8185-28572ce880a3 | coffee_withalarm | CREATE_COMPLETE | 2015-10-10T03:07:06Z |
    +--------------------------------------+------------------+-----------------+----------------------+

    ```
  1. 查看警报列表：

    ```
    # ceilometer alarm-list 
    +--------------------------------------+----------------------------------------------+-------------------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                         | State             | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+----------------------------------------------+-------------------+---------+------------+--------------------------------+------------------+
    | 44c1121d-fb37-4ad4-856d-badebfd8bd8c | coffee_withalarm-cpu_alarm_low-m6pgykcwtsdd  | insufficient data | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    | bab64852-0ef2-4803-9d4c-52542cd7753b | coffee_withalarm-cpu_alarm_high-xasoezd2ioh3 | insufficient data | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    +--------------------------------------+----------------------------------------------+-------------------+---------+------------+--------------------------------+------------------+
    ```
  1. 删除集群：

    ```
    # heat stack-delete <STACK_NAME>
    ```
  1. 查看云主机列表，验证集群中的云主机是否被删除；
  1. 查看警报列表，验证警报是否被删除。

* 预期结果：

  * 删除集群，集群处于 "DELETE_IN_PROGRESS" 状态，删除完成后，集群信息不再显示在列表中：

    ```
    # heat stack-delete coffee_withalarm
    +--------------------------------------+------------------+--------------------+----------------------+
    | id                                   | stack_name       | stack_status       | creation_time        |
    +--------------------------------------+------------------+--------------------+----------------------+
    | 0d58af3f-d0d6-40ef-8185-28572ce880a3 | coffee_withalarm | DELETE_IN_PROGRESS | 2015-10-10T03:07:06Z |
    +--------------------------------------+------------------+--------------------+----------------------+

    ```
  * 查看云主机列表，云主机以被删除，列表为空（该租户下没有其他云主机）：

    ```
    # nova list
    +----+------+--------+------------+-------------+----------+
    | ID | Name | Status | Task State | Power State | Networks |
    +----+------+--------+------------+-------------+----------+
    +----+------+--------+------------+-------------+----------+
    ```
  * 查看警报列表，警报被删除，列表为空（该租户下没有其他警报）：

    ```
    # ceilometer alarm-list
    +----------+------+-------+---------+------------+-----------------+------------------+
    | Alarm ID | Name | State | Enabled | Continuous | Alarm condition | Time constraints |
    +----------+------+-------+---------+------------+-----------------+------------------+
    +----------+------+-------+---------+------------+-----------------+------------------+
    ```

## 删除自动伸缩集群


* 前提：

* 操作：

  1. 登录到 Controller 节点，加载所要删除的基本集群的拥有者的环境变量脚本；
  1. 查看集群列表：

    ```
    # heat stack-list
    +--------------------------------------+---------------+-----------------+----------------------+
    | id                                   | stack_name    | stack_status    | creation_time        |
    +--------------------------------------+---------------+-----------------+----------------------+
    | 518b3d52-6169-4132-9e3e-2d6114eacef3 | coffee_withlb | CREATE_COMPLETE | 2015-10-10T03:22:31Z |
    +--------------------------------------+---------------+-----------------+----------------------+
    ```
  1. 查看警报列表：

    ```
    # ceilometer alarm-list 
    +--------------------------------------+-------------------------------------------+-------------------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                      | State             | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+-------------------------------------------+-------------------+---------+------------+--------------------------------+------------------+
    | c99f2ffd-8d17-4c58-9f0f-01eba8de528f | coffee_withlb-cpu_alarm_low-mnoqjvcvrr4a  | insufficient data | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    | ed93407c-c2bb-4aaa-addc-89144ed3201f | coffee_withlb-cpu_alarm_high-gc4wmi5gneix | insufficient data | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    +--------------------------------------+-------------------------------------------+-------------------+---------+------------+--------------------------------+------------------+
    ```
  1. 查看负载均衡池、负载均衡成员、负载均衡虚拟 IP 列表：

    ```
    # neutron lb-pool-list
    +--------------------------------------+---------------------------------+----------+-------------------+----------+----------------+--------+
    | id                                   | name                            | provider | lb_method         | protocol | admin_state_up | status |
    +--------------------------------------+---------------------------------+----------+-------------------+----------+----------------+--------+
    | 38c4fc41-cdeb-4ec5-b6d7-3843cddc8768 | coffee_withlb-pool-z7gwzfyk6xdx | haproxy  | ROUND_ROBIN       | HTTP     | True           | ACTIVE |
    +--------------------------------------+---------------------------------+----------+-------------------+----------+----------------+--------+

    # neutron lb-member-list
    +--------------------------------------+----------------+---------------+--------+----------------+----------+
    | id                                   | address        | protocol_port | weight | admin_state_up | status   |
    +--------------------------------------+----------------+---------------+--------+----------------+----------+
    | 2b5abc4f-87e2-4045-9dd6-b030089b30d2 | 172.16.200.183 |            80 |      1 | True           | ACTIVE   |
    +--------------------------------------+----------------+---------------+--------+----------------+----------+

    # neutron lb-vip-list
    +--------------------------------------+----------+----------------+----------+----------------+--------+
    | id                                   | name     | address        | protocol | admin_state_up | status |
    +--------------------------------------+----------+----------------+----------+----------------+--------+
    | d6cd297c-f673-4878-894f-5e0c1c5922bc | pool.vip | 172.16.200.182 | HTTP     | True           | ACTIVE |
    +--------------------------------------+----------+----------------+----------+----------------+--------+
    ```
  1. 删除集群：

    ```
    # heat stack-delete <STACK_NAME>
    ```
  1. 查看云主机列表，验证集群中的云主机是否被删除；
  1. 查看警报列表，验证警报是否被删除；
  1. 查看负载均衡各资源列表，验证负载均衡资源是否被删除。

* 预期结果：

  * 删除集群，集群处于 "DELETE_IN_PROGRESS" 状态，删除完成后，集群信息不再显示在列表中：

    ```
    # heat stack-delete coffee_withlb
    +--------------------------------------+---------------+--------------------+----------------------+
    | id                                   | stack_name    | stack_status       | creation_time        |
    +--------------------------------------+---------------+--------------------+----------------------+
    | 518b3d52-6169-4132-9e3e-2d6114eacef3 | coffee_withlb | DELETE_IN_PROGRESS | 2015-10-10T03:22:31Z |
    +--------------------------------------+---------------+--------------------+----------------------+
    ```
  * 查看云主机列表，云主机以被删除，列表为空（该租户下没有其他云主机）：

    ```
    # nova list
    +----+------+--------+------------+-------------+----------+
    | ID | Name | Status | Task State | Power State | Networks |
    +----+------+--------+------------+-------------+----------+
    +----+------+--------+------------+-------------+----------+
    ```
  * 查看警报列表，警报被删除，列表为空（该租户下没有其他警报）：

    ```
    # ceilometer alarm-list
    +----------+------+-------+---------+------------+-----------------+------------------+
    | Alarm ID | Name | State | Enabled | Continuous | Alarm condition | Time constraints |
    +----------+------+-------+---------+------------+-----------------+------------------+
    +----------+------+-------+---------+------------+-----------------+------------------+
    ```
  * 查看负载均衡池、负载均衡成员、负载均衡虚拟 IP 列表，各资源均被删除，列表为空（该租户下没有其他负载均衡资源）：

    ```
    # neutron lb-pool-list
    +----+------+----------+-----------+----------+----------------+--------+
    | id | name | provider | lb_method | protocol | admin_state_up | status |
    +----+------+----------+-----------+----------+----------------+--------+
    +----+------+----------+-----------+----------+----------------+--------+

    # neutron lb-member-list
    +----+---------+---------------+--------+----------------+--------+
    | id | address | protocol_port | weight | admin_state_up | status |
    +----+---------+---------------+--------+----------------+--------+
    +----+---------+---------------+--------+----------------+--------+

    # neutron lb-vip-list
    +----+------+---------+----------+----------------+--------+
    | id | name | address | protocol | admin_state_up | status |
    +----+------+---------+----------+----------------+--------+
    +----+------+---------+----------+----------------+--------+
    ```
