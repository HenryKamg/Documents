# 集群的伸缩

## 基本集群的手动伸缩

* 前提：

  * 已经创建好基本伸缩集群。

* 操作：

  1. 登录到 Controller 节点，加载所要伸缩集群的租户的环境变量脚本；
  1. 获取集群的扩展 URL，手动扩展集群：

    ```
    # heat output-show <STACK_NAME> scale_up_url
    "http://25.0.0.2:8000/v1/signal/arn%3Aopenstack%3Aheat%3A%3Abf87349ae6704a87af75ebe9546d4af6%3Astacks%2Fcoffee_base%2F87174ee8-8ec7-44c9-872b-436b7785450c%2Fresources%2Fscaleup_policy?Timestamp=2015-10-09T07%3A12%3A13Z&SignatureMethod=HmacSHA256&AWSAccessKeyId=06b19e1ae91f421ba1059270b2d287a6&SignatureVersion=2&Signature=byufaHmJAB45m6e%2FdxC1HqYgQcgpiL9%2FXSnmy5Ibou8%3D"

    # curl -X POST <scale_up_url>
    ```
  1. 获取集群的收缩 URL，手动收缩集群：

    ```
    # heat output-show <STACK_NAME> scale_dn_url
    "http://25.0.0.2:8000/v1/signal/arn%3Aopenstack%3Aheat%3A%3Abf87349ae6704a87af75ebe9546d4af6%3Astacks%2Fcoffee_base%2F87174ee8-8ec7-44c9-872b-436b7785450c%2Fresources%2Fscaledown_policy?Timestamp=2015-10-09T07%3A12%3A14Z&SignatureMethod=HmacSHA256&AWSAccessKeyId=4499a08903894bc4a3da30e02acc0ca6&SignatureVersion=2&Signature=Q0UrcTmraxmil0VMCO8iK4ulFxdBHjV6L8R0gXTeD34%3D"

    # curl -X POST <scale_dn_url>
    ```

* 预期结果：

  * 手动扩展集群后，通过 `nova list` 查看，可以看到又新建了一台云主机：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 1591a950-1130-4148-a5c0-4ecc10817601 | co-erver_group-ps6iqozpyg7c-7zrlsdiagxjz-yrp7lpypunfq | ACTIVE | -          | Running     | rally_net=172.16.200.168             |
    | 29b478d3-0f97-4114-9ae0-4257d52629bc | co-erver_group-ps6iqozpyg7c-bmrbbcojxh4h-uwmlnlmn6nq3 | ACTIVE | -          | Running     | rally_net=172.16.200.169             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 手动收缩集群后，通过 `nova list` 查看，可以看到其中一台云主机被删除：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 29b478d3-0f97-4114-9ae0-4257d52629bc | co-erver_group-ps6iqozpyg7c-bmrbbcojxh4h-uwmlnlmn6nq3 | ACTIVE | -          | Running     | rally_net=172.16.200.169             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```

## 自动伸缩集群的伸缩

* 前提：

  * 已经创建好自动伸缩集群。

* 操作：

  1. 登录到 Controller 节点，加载所要伸缩的集群的租户的环境变量脚本；
  1. 访问集群中的云主机，执行：`cat /dev/urandom > /dev/null`；
  1. 等待一段时间后，查看 Ceilometer 是否发出警报；
  1. 发出警报后，查看云主机列表。

* 预期结果：

  * 在云主机中执行 `cat /dev/urandom > /dev/null` 会对 CPU 造成负载，Ceilometer 模块会发出警报：

    ```
    # ceilometer alarm-list
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                         | State | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | 87d23630-ba91-46f3-860a-3a2ac23be704 | coffee_withalarm-cpu_alarm_low-5gteanhksnlt  | ok    | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    | f8756162-8244-4d51-815f-748089e192bc | coffee_withalarm-cpu_alarm_high-kg2rrr2zjmmu | alarm | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    ```

  * 一段时间后再次使用 `nova list` 命令查看，看到又新建了一台云主机：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 95ba71e3-9760-4d06-8141-7f8d79373f70 | co-erver_group-d5zjszaqoxdq-na24eatmmiox-ojzu5qkxbyrq | ACTIVE | -          | Running     | rally_net=172.16.200.171             |
    | 2e109a0d-1f27-4039-9524-77902489843a | co-erver_group-d5zjszaqoxdq-oop5ploa27t5-debzb7kbfrms | ACTIVE | -          | Running     | rally_net=172.16.200.170             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 增加云主机后，停止在云主机中执行的命令，再次等待一段时间，CPU 负载过低，Ceilometer 模块发出警报：

    ```
    # ceilometer alarm-list
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                         | State | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | 87d23630-ba91-46f3-860a-3a2ac23be704 | coffee_withalarm-cpu_alarm_low-5gteanhksnlt  | alarm | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    | f8756162-8244-4d51-815f-748089e192bc | coffee_withalarm-cpu_alarm_high-kg2rrr2zjmmu | ok    | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    ```

  * 再次等待一段时间，使用 `nova list` 命令查看，看到新建的云主机被删除：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 95ba71e3-9760-4d06-8141-7f8d79373f70 | co-erver_group-d5zjszaqoxdq-na24eatmmiox-ojzu5qkxbyrq | ACTIVE | -          | Running     | rally_net=172.16.200.171             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```

> ###### 说明：
> * 本实验所测试的集群为自动伸缩集群，触发条件为 CPU 频率；
> * 触发自动伸缩的条件可以通过修改模板文件来实现，详情请参考[模板文件的格式](https://oa.eayun.cn/wiki/doku.php?id=eayunstack:heat:template_format)。

## 包含负载均衡的自动伸缩集群的伸缩

* 前提：

  * 已经创建好包含负载均衡的自动伸缩集群。

* 操作：

  1. 登录到 Controller 节点，加载所要伸缩集群的租户的环境变量脚本；
  1. 获取云主机虚拟浮动 IP 地址：

    ```
    # heat output-show <STACK_NAME> website_url
    "http://25.0.0.219/"
    ```
  1. 在浏览器中打开该地址；
  1. 访问云主机，在云主机中执行 `cat /dev/urandom > /dev/null`，产生 CPU 负载；
  1. 一段时间后使用 `nova list` 查看是否新增云主机；
  1. 刷新页面，验证页面是否有变化。

* 预期结果：

  * 包含负载均衡的自动伸缩集群创建成功，创建成功后状态会显示为"CREATE_COMPLETE"：

    ```
    # heat stack-create --template-file <PATH_TO_withlb.yaml> --environment-file <PATH_TO_lb_env.yaml> coffee_withlb
    +--------------------------------------+---------------+--------------------+----------------------+
    | id                                   | stack_name    | stack_status       | creation_time        |
    +--------------------------------------+---------------+--------------------+----------------------+
    | 1b6dabcc-ef8b-4f90-834f-a505d840eb72 | coffee_withlb | CREATE_IN_PROGRESS | 2015-10-10T02:17:12Z |
    +--------------------------------------+---------------+--------------------+----------------------+
    ```
  * 查看负载均衡的信息，看到新增了相关内容：

    ```
    # neutron lb-pool-list
    +--------------------------------------+---------------------------------+----------+-------------------+----------+----------------+--------+
    | id                                   | name                            | provider | lb_method         | protocol | admin_state_up | status |
    +--------------------------------------+---------------------------------+----------+-------------------+----------+----------------+--------+
    | 413e0ae3-fdd0-412b-92d6-218d89f52332 | coffee_withlb-pool-4otdunn43dcg | haproxy  | ROUND_ROBIN       | HTTP     | True           | ACTIVE |
    +--------------------------------------+---------------------------------+----------+-------------------+----------+----------------+--------+

    # neutron lb-member-list
    +--------------------------------------+----------------+---------------+--------+----------------+----------+
    | id                                   | address        | protocol_port | weight | admin_state_up | status   |
    +--------------------------------------+----------------+---------------+--------+----------------+----------+
    | 62734e51-969d-42c7-b18f-0e4e398317ce | 172.16.200.179 |            80 |      1 | True           | ACTIVE   |
    +--------------------------------------+----------------+---------------+--------+----------------+----------+

    # neutron lb-vip-list
    +--------------------------------------+----------+----------------+----------+----------------+--------+
    | id                                   | name     | address        | protocol | admin_state_up | status |
    +--------------------------------------+----------+----------------+----------+----------------+--------+
    | 05613198-ed21-46d2-aa14-287fba9174f6 | pool.vip | 172.16.200.178 | HTTP     | True           | ACTIVE |
    +--------------------------------------+----------+----------------+----------+----------------+--------+
    ```
  * 在浏览器打开地址后，显示云主机的主机名和自动伸缩集群的 ID；

    ```
    co-kh35-hu7bydynwiqq-hg3mjwcuimeb-server-lsuduu2m2oku 1b6dabcc-ef8b-4f90-834f-a505d840eb72
    ```
  * 产生 CPU 负载一段时间后，Ceilometer 模块发出警报：

    ```
    # ceilometer alarm-list
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                      | State | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | 9a787e4f-7144-450b-8eea-df4460a5d9bc | coffee_withlb-cpu_alarm_high-ptvv5bvlir2c | alarm | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    | f887b3c7-3d0c-4bb5-965c-cf49628dad6e | coffee_withlb-cpu_alarm_low-behwzf2zi3mv  | ok    | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    ```
  * 使用 `nova list` 查看，看到新建一台云主机：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 0bab069f-6c72-4e5a-a301-7417ff6a478d | co-kh35-hu7bydynwiqq-hg3mjwcuimeb-server-lsuduu2m2oku | ACTIVE | -          | Running     | rally_net=172.16.200.179             |
    | 5d2c11d9-a98d-4759-8dc1-b79df9d334b2 | co-kh35-ijsbyg5w3slz-bboba3lchfmf-server-65yrvgrrzonw | ACTIVE | -          | Running     | rally_net=172.16.200.180             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 刷新页面后，看到页面显示的云主机名称有变化：

    ```
    co-kh35-ijsbyg5w3slz-bboba3lchfmf-server-65yrvgrrzonw 1b6dabcc-ef8b-4f90-834f-a505d840eb72
    ```
  * 负载均衡的成员增加：

    ```
    # neutron lb-member-list
    +--------------------------------------+----------------+---------------+--------+----------------+--------+
    | id                                   | address        | protocol_port | weight | admin_state_up | status |
    +--------------------------------------+----------------+---------------+--------+----------------+--------+
    | 62734e51-969d-42c7-b18f-0e4e398317ce | 172.16.200.179 |            80 |      1 | True           | ACTIVE |
    | bbeecac4-6781-429f-bef0-4b5482b6286b | 172.16.200.180 |            80 |      1 | True           | ACTIVE |
    +--------------------------------------+----------------+---------------+--------+----------------+--------+
    ```
  * 访问云主机，停止执行命令，等待一段时间，CPU 负载下降，Ceilometer 模块发出警报：

    ```
    # ceilometer alarm-list
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                      | State | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | 9a787e4f-7144-450b-8eea-df4460a5d9bc | coffee_withlb-cpu_alarm_high-ptvv5bvlir2c | ok    | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    | f887b3c7-3d0c-4bb5-965c-cf49628dad6e | coffee_withlb-cpu_alarm_low-behwzf2zi3mv  | alarm | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    ```
  * 使用 `nova list` 查看云主机，看到被删除了一台云主机：

    ```
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 5d2c11d9-a98d-4759-8dc1-b79df9d334b2 | co-kh35-ijsbyg5w3slz-bboba3lchfmf-server-65yrvgrrzonw | ACTIVE | -          | Running     | rally_net=172.16.200.180             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 负载均衡成员减少：

    ```
    # neutron lb-member-list
    +--------------------------------------+----------------+---------------+--------+----------------+--------+
    | id                                   | address        | protocol_port | weight | admin_state_up | status |
    +--------------------------------------+----------------+---------------+--------+----------------+--------+
    | bbeecac4-6781-429f-bef0-4b5482b6286b | 172.16.200.180 |            80 |      1 | True           | ACTIVE |
    +--------------------------------------+----------------+---------------+--------+----------------+--------+
    ```
  * 再次刷新页面，页面无变化。

> ###### 说明：
> * 本次实验对 TCP 的 80 端口进行负载均衡的测试；
> * 详细信息和模板的使用请参考[wiki](https://oa.eayun.cn/wiki/doku.php?id=eayunstack:heat:autoscaling)。

