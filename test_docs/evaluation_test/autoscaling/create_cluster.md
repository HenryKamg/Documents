# 创建自动伸缩集群

## 创建基本伸缩集群

* 前提：

  * 已经写好模板文件：[base.yaml]()，保存在 Controller 节点上；
  * 已经写好参数文件：[base_env.yaml]()，保存在 Controller 节点上。

* 操作：

  1. 登录到 Controller 节点，加载环境变量脚本；
  1. 创建伸缩集群：

    ```
    # 不使用环境参数文件：
    # heat stack-create --template-file <PATH_TO_base.yaml> --parameters "image=TestVM;flavor=m1.tiny;key_name=rally_coffee;network=rally_net" <STACK_NAME>

    # 使用环境参数文件：
    # heat stack-create --template-file <PATH_TO_base.yaml> --environment-file <PATH_TO_base_env.yaml>
    ```
  1. 获取集群的扩展 URL，手动扩展集群：

    ```
    # heat output-show <STACK_NAME> scale_up_url
    "http://25.0.0.2:8000/v1/signal/arn%3Aopenstack%3Aheat%3A%3Abf87349ae6704a87af75ebe9546d4af6%3Astacks%2Fcoffee_base%2F87174ee8-8ec7-44c9-872b-436b7785450c%2Fresources%2Fscaleup_policy?Timestamp=2015-10-09T07%3A12%3A13Z&SignatureMethod=HmacSHA256&AWSAccessKeyId=06b19e1ae91f421ba1059270b2d287a6&SignatureVersion=2&Signature=byufaHmJAB45m6e%2FdxC1HqYgQcgpiL9%2FXSnmy5Ibou8%3D"

    # curl -X POST <scale_up_url>
    ```
  1. 获取集群的收缩 URL，手动收缩集群：

    ```
    # heat output-show <STACK_NAME> scale_dn_url
    "http://25.0.0.2:8000/v1/signal/arn%3Aopenstack%3Aheat%3A%3Abf87349ae6704a87af75ebe9546d4af6%3Astacks%2Fcoffee_base%2F87174ee8-8ec7-44c9-872b-436b7785450c%2Fresources%2Fscaledown_policy?Timestamp=2015-10-09T07%3A12%3A14Z&SignatureMethod=HmacSHA256&AWSAccessKeyId=4499a08903894bc4a3da30e02acc0ca6&SignatureVersion=2&Signature=Q0UrcTmraxmil0VMCO8iK4ulFxdBHjV6L8R0gXTeD34%3D"

    # curl -X POST <scale_dn_url>
    ```

* 预期结果

  * 伸缩集群创建成功：

    ```
    # heat stack-create --template-file <PATH_TO_base.yaml> --environment-file <PATH_TO_base_env.yaml> coffee_base
    +--------------------------------------+------------------+--------------------+----------------------+
    | id                                   | stack_name       | stack_status       | creation_time        |
    +--------------------------------------+------------------+--------------------+----------------------+
    | 87174ee8-8ec7-44c9-872b-436b7785450c | coffee_base      | CREATE_IN_PROGRESS | 2015-10-09T07:12:03Z |
    +--------------------------------------+------------------+--------------------+----------------------+
    ```
  * 使用 `nova list` 命令查看，可以看到新建了一台云主机：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 1591a950-1130-4148-a5c0-4ecc10817601 | co-erver_group-ps6iqozpyg7c-7zrlsdiagxjz-yrp7lpypunfq | ACTIVE | -          | Running     | rally_net=172.16.200.168             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 手动扩展集群后，通过 `nova list` 查看，可以看到又新建了一台云主机：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 1591a950-1130-4148-a5c0-4ecc10817601 | co-erver_group-ps6iqozpyg7c-7zrlsdiagxjz-yrp7lpypunfq | ACTIVE | -          | Running     | rally_net=172.16.200.168             |
    | 29b478d3-0f97-4114-9ae0-4257d52629bc | co-erver_group-ps6iqozpyg7c-bmrbbcojxh4h-uwmlnlmn6nq3 | ACTIVE | -          | Running     | rally_net=172.16.200.169             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 手动收缩集群后，通过 `nova list` 查看，可以看到其中一台云主机被删除：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 29b478d3-0f97-4114-9ae0-4257d52629bc | co-erver_group-ps6iqozpyg7c-bmrbbcojxh4h-uwmlnlmn6nq3 | ACTIVE | -          | Running     | rally_net=172.16.200.169             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```

> ###### 说明：
> * 本实验中使用了两种方法创建伸缩集群：使用 --parameters 参数和使用 --environment-file 参数，二者实质是一样的，但随着参数的增加，后者在实际使用中将更为方便；
> * 本实验中所创建的伸缩集群不是自动伸缩集群，没有自动伸缩机制。

## 创建可自动伸缩的集群

* 前提：

  * 已经写好创建自动伸缩集群的模板：[withalarm.yaml]()，并保存在 Controller 节点上；
  * 已经写好参数文件：[base_env.yaml]()，并保存在 Controller 节点上。

* 操作：

  1. 登录到 Controller 节点，加载环境变量脚本；
  1. 创建自动伸缩集群：

    ```
    # heat stack-create --template-file <PATH_TO_withalarm.yaml> --environment-file <PATH_TO_base_env.yaml> <STACK_NAME>
    ```
  1. 集群创建成功后，会创建一台云主机，访问云主机，执行：`cat /dev/urandom > /dev/null`
  1. 等待一段时间后，查看云主机列表。

* 预期结果：

  * 自动伸缩集群创建成功：

    ```
    # heat stack-create --template-file coffee/withalarm.yaml --environment-file coffee/withalarm_env.yaml coffee_withalarm
    +--------------------------------------+------------------+--------------------+----------------------+
    | id                                   | stack_name       | stack_status       | creation_time        |
    +--------------------------------------+------------------+--------------------+----------------------+
    | 91707ea8-4ccc-40b2-85be-1d71d91d045d | coffee_withalarm | CREATE_IN_PROGRESS | 2015-10-09T07:39:05Z |
    +--------------------------------------+------------------+--------------------+----------------------+
    ```
  * 使用 `nova list` 查看云主机列表，看到新建了一台云主机：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 2e109a0d-1f27-4039-9524-77902489843a | co-erver_group-d5zjszaqoxdq-oop5ploa27t5-debzb7kbfrms | ACTIVE | -          | Running     | rally_net=172.16.200.170             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 在 Ceilometer 模块中创建了对应的警报：

    ```
    # ceilometer alarm-list
    +--------------------------------------+----------------------------------------------+-------------------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                         | State             | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+----------------------------------------------+-------------------+---------+------------+--------------------------------+------------------+
    | 87d23630-ba91-46f3-860a-3a2ac23be704 | coffee_withalarm-cpu_alarm_low-5gteanhksnlt  | insufficient data | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    | f8756162-8244-4d51-815f-748089e192bc | coffee_withalarm-cpu_alarm_high-kg2rrr2zjmmu | insufficient data | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    +--------------------------------------+----------------------------------------------+-------------------+---------+------------+--------------------------------+------------------+
    ```
  * 在云主机中执行 `cat /dev/urandom > /dev/null` 会对 CPU 造成负载，Ceilometer 模块会发出警报：

    ```
    # ceilometer alarm-list
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                         | State | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | 87d23630-ba91-46f3-860a-3a2ac23be704 | coffee_withalarm-cpu_alarm_low-5gteanhksnlt  | ok    | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    | f8756162-8244-4d51-815f-748089e192bc | coffee_withalarm-cpu_alarm_high-kg2rrr2zjmmu | alarm | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    ```

  * 一段时间后再次使用 `nova list` 命令查看，看到又新建了一台云主机：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 95ba71e3-9760-4d06-8141-7f8d79373f70 | co-erver_group-d5zjszaqoxdq-na24eatmmiox-ojzu5qkxbyrq | ACTIVE | -          | Running     | rally_net=172.16.200.171             |
    | 2e109a0d-1f27-4039-9524-77902489843a | co-erver_group-d5zjszaqoxdq-oop5ploa27t5-debzb7kbfrms | ACTIVE | -          | Running     | rally_net=172.16.200.170             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 增加云主机后，停止在云主机中执行的命令，再次等待一段时间，CPU 负载过低，Ceilometer 模块发出警报：

    ```
    # ceilometer alarm-list
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                         | State | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | 87d23630-ba91-46f3-860a-3a2ac23be704 | coffee_withalarm-cpu_alarm_low-5gteanhksnlt  | alarm | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    | f8756162-8244-4d51-815f-748089e192bc | coffee_withalarm-cpu_alarm_high-kg2rrr2zjmmu | ok    | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    +--------------------------------------+----------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    ```

  * 再次等待一段时间，使用 `nova list` 命令查看，看到新建的云主机被删除：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 95ba71e3-9760-4d06-8141-7f8d79373f70 | co-erver_group-d5zjszaqoxdq-na24eatmmiox-ojzu5qkxbyrq | ACTIVE | -          | Running     | rally_net=172.16.200.171             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```

> ###### 说明：
> * 本实验所创建的集群为自动伸缩集群，触发条件为 CPU 频率；
> * 触发自动伸缩的条件可以通过修改模板文件来实现，详情请参考[模板文件的格式](https://oa.eayun.cn/wiki/doku.php?id=eayunstack:heat:template_format)。

## 创建包含负载均衡的自动伸缩集群

* 前提：

  * 已经准备好模板文件：[withlb.yaml]()，并保存在 Controller 节点上；
  * 已经准备好负载均衡服务器信息模板：[lb_server.yaml]()，并保存在 Controller 节点上；
  * 已经准备好参数文件：[lb_env.yaml]()，并保存在 Controller 节点上。

* 操作：

  1. 登录到 Controller 节点，加载环境变量脚本；
  1. 创建包含负载均衡的自动伸缩集群：

    ```
    # heat stack-create --template-file <PATH_TO_withlb.yaml> --environment-file <PATH_TO_lb_env.yaml> <STACK_NAME>
    ```
  1. 获取云主机虚拟浮动 IP 地址：

    ```
    # heat output-show <STACK_NAME> website_url
    "http://25.0.0.196/"
    ```
  1. 在浏览器中打开该地址；
  1. 访问云主机，在云主机中执行 `cat /dev/urandom > /dev/null`，产生 CPU 负载；
  1. 一段时间后使用 `nova list` 查看是否新增云主机；
  1. 刷新页面，验证页面是否有变化。

* 预期结果：

  * 包含负载均衡的自动伸缩集群创建成功，创建成功后状态会显示为"CREATE_COMPLETE"：

    ```
    # heat stack-create --template-file <PATH_TO_withlb.yaml> --environment-file <PATH_TO_lb_env.yaml> coffee_withlb
    +--------------------------------------+---------------+--------------------+----------------------+
    | id                                   | stack_name    | stack_status       | creation_time        |
    +--------------------------------------+---------------+--------------------+----------------------+
    | 80a99e67-b764-402f-906b-e13a3eae5e0d | coffee_withlb | CREATE_IN_PROGRESS | 2015-10-09T10:06:05Z |
    +--------------------------------------+---------------+--------------------+----------------------+
    ```
  * 在浏览器打开地址后，显示云主机的主机名和自动伸缩集群的 ID；

    ```
    co-jyh5-ecpxeahp4q3i-aa7zjabpqgi7-server-ra32jkloa5pa 80a99e67-b764-402f-906b-e13a3eae5e0d
    ```
  * 产生 CPU 负载一段时间后，Ceilometer 模块发出警报：

    ```
    # ceilometer alarm-list
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                      | State | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | 2ca5d960-c0be-456c-bd71-d53eb6b6d63a | coffee_withlb-cpu_alarm_low-dmc4h6focgwa  | ok    | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    | e5b210af-ded5-4248-b63e-ca64a0f0b60b | coffee_withlb-cpu_alarm_high-h5g3nyhdmbpc | alarm | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    ```
  * 使用 `nova list` 查看，看到新建一台云主机：

    ```
    # nova list
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 42159b1f-ff19-4487-86b9-96bc8d4391cd | co-jyh5-ecpxeahp4q3i-aa7zjabpqgi7-server-ra32jkloa5pa | ACTIVE | -          | Running     | rally_net=172.16.200.174             |
    | 6db230e1-bcbf-40a2-9988-3a53feb7c244 | co-jyh5-wgoigrkvj5ul-ya2cdikrssgm-server-ozcsx2es3kwu | ACTIVE | -          | Running     | rally_net=172.16.200.175             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 刷新页面后，看到页面显示的云主机名称有变化：

    ```
    co-jyh5-wgoigrkvj5ul-ya2cdikrssgm-server-ozcsx2es3kwu 80a99e67-b764-402f-906b-e13a3eae5e0d
    ```
  * 访问云主机，停止执行命令，等待一段时间，CPU 负载下降，Ceilometer 模块发出警报：

    ```
    # ceilometer alarm-list 
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | Alarm ID                             | Name                                      | State | Enabled | Continuous | Alarm condition                | Time constraints |
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    | 2ca5d960-c0be-456c-bd71-d53eb6b6d63a | coffee_withlb-cpu_alarm_low-dmc4h6focgwa  | alarm | True    | False      | cpu_util < 15.0 during 1 x 60s | None             |
    | e5b210af-ded5-4248-b63e-ca64a0f0b60b | coffee_withlb-cpu_alarm_high-h5g3nyhdmbpc | ok    | True    | False      | cpu_util > 50.0 during 1 x 60s | None             |
    +--------------------------------------+-------------------------------------------+-------+---------+------------+--------------------------------+------------------+
    ```
  * 使用 `nova list` 查看云主机，看到被删除了一台云主机：

    ```
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | ID                                   | Name                                                  | Status | Task State | Power State | Networks                             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    | 6db230e1-bcbf-40a2-9988-3a53feb7c244 | co-jyh5-wgoigrkvj5ul-ya2cdikrssgm-server-ozcsx2es3kwu | ACTIVE | -          | Running     | rally_net=172.16.200.175             |
    +--------------------------------------+-------------------------------------------------------+--------+------------+-------------+--------------------------------------+
    ```
  * 再次刷新页面，页面无变化。

> ###### 说明：
> * 本次实验对 TCP 的 80 端口进行负载均衡的测试；
> * 详细信息和模板的使用请参考[wiki](https://oa.eayun.cn/wiki/doku.php?id=eayunstack:heat:autoscaling)。
