# 验证 Cinder 组件的 snapshot 部分

|内容编号|内容名称|
|--------|--------|
|02|快照|


|测试编号|测试目的|操作|预期结果|实际结果|备注|Rally/Tempest/None|
|--------|--------|----|--------|--------|----|------------------|
|01030201|测试快照的创建(默认是基于卷创建快照)|<ul><li>UI:<ol><li>登录到 dashboard；</li><li>点击左侧导航栏的 【Project】，展开选项卡；</li><li>点击 【Compute】 子选项卡，展开；</li><li>点击 【Volumes】 选项，选择一个现有的卷；</li><li>点击该卷的 【Actions】 下拉图标，点击 【Creat Snapshot】；</li><li>在弹出的 【Create Volume Snapshot】 窗口中，输入 Snapshot Name，选择性地输入 Description，点击 【Create Volume Snapshot】 按钮。</li></ol></li></ul><ul><li>CLI:<ol><li>登录到 rally 测试服务器；</li><li>使用 rally 测试文件 create-and-list-snapshots.yaml；</li><li>执行测试命令 <code>rally task start create-and-list-snapshots.yaml</code>。</li></ol></li></ul>|<ul><li>UI:<ul><li>快照创建成功，快照的状态变化为 Creating -> Available</li></ul></li></ul><ul><li>CLI:<ul><li>Rally 测试成功</li></ul></li></ul>||基于附加给实例的卷创建快照(有可能导致损坏的快照)，rally 中参数为 force|Rally:</br>create-and-list-snapshots.yaml|
||基于未附加卷的实例创建快照|<ul><li>UI:<ol><li>登录到 dashboard；</li><li>点击左侧导航栏的 【Project】，展开选项卡；</li><li>点击 【Compute】 子选项卡，展开；</li><li>点击 【Instances】 选项，在右侧的实例列表中选择一台实例；</li><li>点击该实例的 【Actions】 中的 【Create Snapshot】；</li><li>在弹出的 【Create Snapshot】 窗口中，输入 Snapshot Name，点击 【Create Snapshot】 按钮，创建实例快照。</li></ol></li></ul><ul><li>CLI:<ol><li>登录到 Controller 节点；</li><li>用 OpenStack 的 admin 用户执行命令 <code>nova image-create --show --poll \<server_id or server_name\> \<snp_name\></code>，其中所选择的实例是正在运行(状态为 Running)的实例。</li></ol></li></ul>|<ul><li>UI:<ul><li>快照创建成功，在 【Images】 选项卡下可以看到新创建的快照，Type 显示为 Snapshot</li><li>快照的状态变化为 Queued -> Spaning -> Active</li></ul></li><li>CLI:<ul><li>命令执行成功，创建实例的快照</li><li>创建完成后，显示快照的详细信息</li><li>快照的类型被设置为 image</li></ul></li></ul>||需要修改 flavor name 和 image name 参数|可以用 Rally 实现(待验证)</br>boot-snapshot-boot-delete.yaml|
||基于已附加卷的实例创建快照|<ul><li>UI:<ol><li>登录到 dashboard；</li><li>点击左侧导航栏的 【Project】，展开选项卡；</li><li>点击 【Compute】 子选项卡，展开；</li><li>点击 【Instances】 选项，在右侧的实例列表中选择一台已附加卷的实例；</li><li>点击该实例的 【Actions】 中的 【Create Snapshot】；</li><li>在弹出的 【Create Snapshot】 窗口中，输入 Snapshot Name，点击 【Create Snapshot】 按钮，创建实例快照。</li></ol></li></ul><ul><li>CLI:<ol><li>登录到 Controller 节点；</li><li>执行命令 <code>nova image-create --show --poll \<server_id or server_name\> \<snp_name\></code>，其中所选择的实例是一台已附加了卷的实例。</li></ol></li></ul>|<ul><li>UI:<ul><li>快照创建成功，在 【Images】 选项卡下可以看到新创建的快照，Type 显示为 Snapshot</li><li>快照的状态变化为 Queued -> Spaning -> Active</li><li>在 【Volume】 选项卡的 【Volume Snapshot】 标签下，看到新建了一个卷的快照，这个快照是实例所附加的卷的快照</li></ul></li><li>CLI:<ul><li>命令执行成功，输出快照的信息；</li><li>在 Controller 节点上执行命令 <code>cinder snapshot-list</code>，看到列出的快照中有一个名为 "snapshot for \<server_name\>" 的卷的快照</ul>|||None|
||基于已附加给实例的卷创建快照|<ul><li>UI:<ol><li>登录到 dashboard；</li><li>点击左侧导航栏的 【Project】，展开选项卡；</li><li>点击 【Compute】 子选项卡，展开；</li><li>点击 【Volumes】 选项，选择一个已附加给实例的卷(即状态为 In-Use)；</li>点击 【Actions】 中的 【Create Snapshot】；</li><li>在弹出的 【Create Volume Snapshot】 窗口中，填写 Snapshot Name，点击窗口下方的 【Create Volume Snapshot (Force)】。</li></ol></li><li>CLI:<ol><li>登录到 Controller 节点；</li><li>执行命令 <code>cinder snapshot-create \<volume_id or volume_name\> --force True</code>，其中所选择的 volume 是已被附加给实例的卷(即状态为 In-Use)。</li></ol></li></ul>|<ul><li>UI:<ul><li>快照创建成功，快照的状态变化为 Creating -> Available</li></ul></li><li>CLI:<ul><li>不使用 --force 参数时，命令执行失败，提示："ERROR: Bad Request (HTTP 400)"</li><li>使用 --force 参数后，命令执行成功，成功创建快照并输出所创建的快照的信息</li></ul></li></ul>|||None|
|01030202|删除基于卷创建的快照|<ul><li>UI:<ol><li>登录到 dashboard；</li><li>点击左侧导航栏的 【Project】，展开选项卡；</li><li>点击 【Compute】 子选项卡，展开；</li><li>点击 【Volume】 选项卡，在右侧点击 【Volume Snapshot】 标签；</li><li>选择一个快照，点击 【Actions】 的下拉图标，点击 【Delete Volume Snapshot】；</li><li>在弹出的 【Confirm Delete Volume Snapshot】 确认窗口中，点击 【Delete Volume Snapshot】 按钮。</li></ol></li></ul><ul><li>CLI:<ol><li>登录到 rally 测试服务器；</li><li>使用 rally 测试文件 create-and-delete-snapshot.yaml；</li><li>执行测试命令 <code>rally task start create-and-delete-snapshot.yaml</code>。</li></ol></li></ul>|<ul><li>UI:<ul><li>卷的状态变为 Deleting</li><li>卷删除成功，列表中不再显示卷的信息</li></ul></li></ul><ul><li>CLI:<ul><li>Rally 测试成功</li></ul></li></ul>|||Rally:</br>create-and-delete-snapshot.yaml|
|01030202|删除基于实例创建的快照|<ul><li>UI:<ol><li>登录到 dashboard；</li><li>点击左侧导航栏的 【Project】，展开选项卡；</li><li>点击 【Compute】 子选项卡，展开；</li><li>点击 【Images】 选项卡，在右侧选择一个 Type 为 "Snapshot" 的镜像，点击 【Actions】 的下拉图标，点击 【Delete Image】；</li><li>在弹出的 【Confirm Delete Image】 确认窗口中，点击窗口下方的 【Delete Image】 按钮。</li></ol></li></ul><ul><li>CLI:<ol><li>登录到 Controller 节点；</li><li>执行命令 <code>nova image-delete \<image_id or image_name\></code>，其中所选择的镜像为基于实例所创建的快照。</li></ol></li></ul>|<ul><li>UI:<ul><li>卷的状态变为 Deleting</li><li>卷删除成功，列表中不再显示卷的信息</li></ul></li></ul><ul><li>CLI:<ul><li>命令执行成功，基于实例所创建的快照被删除</li><li>使用 <code>nova image-list</code> 命令查看，不再显示该快照的信息</li></ul></li></ul>|||None|
|01030203|更新快照状态，验证是否能够执行非法操作|<ul><li>UI:<ol><li>登录到 dashboard；</li><li>点击左侧导航栏的 【Admin】，展开选项卡；</li><li>点击 【System】 子选项卡，展开；</li><li>点击 【Volumes】 选项卡，在右侧点击 【Volume Snapshots】 标签；</li><li>选择一个状态为 "Available" 的快照，点击 【Actions】 下拉选项中的 【Update Status】；</li><li>在弹出的 【Update Volume Snapshot Status】 窗口中，选择 Status 为其他非正常状态("Creating", "Deleting", "Error", "Error Deleting")，点击窗口下方的 【Update Status】 按钮。</li></ol></li><li>CLI:<ol><li>登录到一台 Controller 节点；</li><li>执行命令 <code>cinder snapshot-reset-state --state <state> <snapshot></code>；</li><li>可更新的状态有 "error", "creating", "deleting", "error_deleting"，默认状态是 "available"</li></ol></li></ul>|<ul><li>UI:<ul><li>状态更新成功，更新状态为非正常状态后，只能对快照执行删除操作</li></ul></li><li>CLI:<ul><li>命令执行成功，快照状态被更新</li><li>除删除命令，其他命令都无法成功执行</li></ul></li></ul>|||None|
||修改基于卷创建的快照|<ul><li>UI:<ol><li>登录到 dashboard；</li><li>点击左侧导航栏的 【Project】，展开选项卡；</li><li>点击 【Compute】 子选项卡，展开；</li><li>点击 【Volume】 选项卡，在右侧点击 【Volume Snapshot】 标签；</li><li>选择一个状态为 "Available" 的快照，点击 【Actions】 的下拉图标，点击 【Edit Snapshot】；</li><li>在弹出的 【Edit Snapshot】 窗口中，可修改快照的 Snapshot Name 和 Description，修改后，点击窗口下方的 【Edit Snapshot】 按钮。</li></ol></li><li>CLI:<ol><li>登录到 Controller 节点；</li><li>执行命令 <code>cinder snapshot-rename <snapshot> <display-name></code>。</li></ol></li></ul>|<ul><li>UI:<ul><li>修改快照成功，快照修改为新的名称和描述</li></ul></li><li>CLI:<ul><li>命令执行成功，快照名称和描述被修改</li></ul></li></ul>|||None|
||修改基于实例创建的快照|<ul><li>UI:<ol><li>登录到 dashboard；</li><li>点击左侧导航栏的 【Project】，展开选项卡；</li><li>点击 【Compute】子选项卡，展开；</li><li>点击 【Images】 选项卡，在右侧选择一个 Type 为 "Snapshot" 的镜像，点击 【Actions】 中的 【Edit】；</li><li>在弹出的 【Update Image】 窗口中，可修改 Name, Format, Minimum Disk, Minimum RAM，并选择是否勾选 Public 和 Protected；</li><li>修改后，点击窗口下方的 【Update Image】 按钮。</li></ol></li><li>CLI:<ol><li>登录到 Controller 节点；</li><li>执行命令 <code>glance image-update --name <NAME></code>；</li><li>可以加其他参数，修改其他选项。</li></ol></li></ul>|<ul><ul><li>UI:<ul><li>修改快照成功，界面上显示新的快照信息</li></ul></li><li>CLI:<ul><li>执行命令成功，快照信息被修改</li></ul></li></ul>|||None|
