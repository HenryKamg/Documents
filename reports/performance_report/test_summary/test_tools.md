# 测试工具介绍

## 存储性能测试工具

FIO 是测试 IOPS 的非常好的工具，用来对硬件进行压力测试和验证，支持 13 种不同的 I/O 引擎，包括：sync, mmap, libaio, posixaio, SG v3, splice, null, network, syslet, guasi, solarisaio 等等。

要获得硬盘的性能，对测试工具来说，就是得到 IOPS 和 MBPS 的峰值。

要提高硬盘利用率，只有一个办法，就是**增加硬盘队列深度**。加大队列深度，即让硬盘不断工作，减少硬盘的空闲时间。

增加队列深度的办法有很多：

* 使用异步 IO，同时发起多个 IO 请求，相当于队列中有多个 IO 请求；
* 多线程发起同步 IO 请求，相当于队列中有多个 IO 请求；
* 增加应用 IO 大小，到达底层之后，会变成多个 IO 请求，相当于队列中有多个 IO 请求。

综上所述，要增加队列深度，相当于增加 IO 请求数量。但要注意控制在一定范围内。

### FIO 使用示例和说明

fio 命令的使用示例如下：

```
$ fio -ioengine=libaio -bs=4k -direct=1 -thread -rw=randwrite \
  -size=1000G -filename=/dev/vdb \
  -name="4K randwrite test" -iodepth=64 -runtime=60
```

> ###### 参数说明：
> * ***ioengine***: 负载引擎，一般使用 libaio，发起异步请求；
> * ***bs***: IO 大小；
> * ***direct***: 直接写，绕过系统 cache。由于测试的是硬盘性能，而不是系统 cache，因此设置为 1 (True)；
> * ***rw***: 读写模式，包括随机写(randwrite)、随机读(randread)、顺序写(write)、顺序读(read)、随机读写(randrw)、顺序读写(rw 或 readwrite)；
> * ***size***: 寻址空间，IO 会落在 [0, size) 这个区间的硬盘空间上。这是一个可以影响 IOPS 的参数，一般设置为所测试的硬盘的大小；
> * ***filename***: 测试对象；
> * ***iodepth***: 队列深度，当使用 libaio 负载引擎并设置 direct 为 1 时，这个参数才有意义。这是一个可以影响 IOPS 的参数；
> * ***runtime***: 测试时长。

### 测试方式

将 fio 工具的使用写入脚本，实现自动化测试。

对于 EayunStack 节点的测试，可以直接执行脚本，获得测试结果。

对于云主机的测试，则借助 Rally 的 VMTask 标准场景，完成自动化测试。

测试方法详情请参考 [EayunStack 性能测试方案](http://docs.eayun.cn/zh-CN/EayunStack/1.0/html/performance_test/content/vm_storage.html)。

## 网络性能测试工具

iperf 是一个 TCP/IP 和 UDP/IP 的性能测量工具，即网络性能的测试工具，能够测试 TCP 和 UDP 的网络带宽质量。

iperf 能够提供网络吞吐率信息，以及震动、丢包率、最大段和最大传输单元大小等统计信息，从而能够帮助我们测试网络性能，定位网络瓶颈。

### iperf 工作原理

iperf 的测试需要服务器端和客户端。

Iperf 测试 TCP 带宽的原理较简单，即在客户端和服务器端建立连接(三次握手)后，客户端发送一定大小的数据报，并记下发送的时间，或者客户端在一定的时间内发送数据，并记下发送的总数据。带宽的大小等于发送的总数据除以发送的总时间。对服务器端来说，就是在连接建立时间内，接收的总数据除以所花的时间即为服务器端所测得的带宽。MSS 的大小通过 TCP 内核接口函数直接获得。

iperf 测试 UDP 的性能时，客户端可以指定 UDP 数据流的速率。客户端发送数据时，会根据客户提供的速率计算数据报发送之间的时延。另外，客户还可以指定发送数据报的大小。每个发送的数据报包含一个 ID 号，用来唯一地标识该报文。服务器端则根据该 ID 号来确定数据报丢失和乱序。当把 UDP 报文大小设置可以将整个报文放入 IP 层的包 (packet) 内时，那么 UDP 所测得的报文丢失数据即为 IP 层包的丢失数据。这提供了一个有效的测试包丢失情况的方法。数据报传输延迟抖动 (Jitter) 的测试由服务器端完成，客户发送的报文数据包含有发送时间戳，服务器端根据该时间信息和接收到报文的时间戳来计算传输延迟抖动。传输延迟抖动反映传输过程中是否平滑。由于它是一个相对值，所以并不需要客户端和服务器端时间同步。

### iperf 使用示例和说明

准备两台机器（为了不相互干扰）作为 TCP 和 UDP 测试的服务器端，执行下列命令：

```
# TCP 服务器端：
$ iperf -s -i 5

# UDP 服务器端：
$ iperf -u -s -i 5
```

在客户端，执行下列命令进行测试：

```
# TCP 网络性能测试：
$ iperf -c <tcp_server_ip> -t 120

# UCP 网络性能测试：
$ iperf -u -c <udp_server_ip> -5 -b 1000M -t 120
```

* 在服务器端和客户端均可看到输出结果。

> ##### 参数说明：
> * ***-s***: 以 server 模式启动
> * ***-c***: 以 client 模式启动
> * 通用参数：
>   * ***-i***: 显示报告的时间间隔，以秒为单位；
>   * ***-p***: 指定服务器端使用的端口或客户端所连接的端口；
>   * ***-u***: 使用 UDP 协议；
>   * ***-w***: 指定 TCP 窗口大小，如果不指定，则使用默认值 8KB；
> * 服务器端专用参数：
>   * ***-D***: 以服务方式运行 iperf；
>   * ***-R***: 停止 iperf 服务，针对 -D 使用；
> * 客户端专用参数：
>   * ***-d***: 同时进行双向传输测试；
>   * ***-r***: 单独进行双向传输测试；
>   * ***-n***: 指定传输的字节数；
>   * ***-t***: 测试时间，以秒为单位，默认是 10；
>   * ***-b***: UDP 测试使用，指定带宽，默认是 1Mbps；
>   * ***-F***: 指定需要传输的文件。
>
> 其他参数请使用 man 命令查询。

### 测试方式

启动两台机器作为测试服务器，将 iperf 工具的测试写入脚本，实现自动化测试。

对于 EayunStack 节点的测试，可以执行脚本，获得测试结果。

对于云主机的测试，则借助 Rally 的 VMTask 标准场景，完成自动化测试。

测试方法详情请参考 [EayunStack 性能测试方案](http://docs.eayun.cn/zh-CN/EayunStack/1.0/html/performance_test/content/vm_network.html)。
